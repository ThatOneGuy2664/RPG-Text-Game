<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro RPG Console</title>
    <script src="Fengari/fengari-web.js"></script>
    <script src="vars.js"></script>
    <style>
        body {
            font-family: monospace;
            background-color: #222;
            color: #fff;
        }
        #consoleOutput {
            background-color: #333;
            border: 1px solid #444;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            white-space: pre-wrap;
        }
        #luaInput {
            width: 100%;
            background-color: #555;
            color: #fff;
            border: 1px solid #444;
            padding: 5px;
            font-size: 16px;
            resize: none;
        }
    </style>
</head>
<body>

    <h1>Retro RPG Console</h1>
    <div id="consoleOutput">Welcome to the game!</div>
    <textarea id="luaInput" placeholder="Type your input here..."></textarea>
    <button id="runCommand">Submit</button>

    <script>
        const outputElement = document.getElementById("consoleOutput");
        const inputElement = document.getElementById("luaInput");
        const runButton = document.getElementById("runCommand");

        // Custom Print Function (Redirects Lua print output)
        function customPrint(...args) {
            const message = args.map(arg => arg.toString()).join(" ");
            const outputText = `<span style="color:white; display:block;">${message}</span>`; // Ensure line breaks
            outputElement.innerHTML += outputText + "<br>"; // Add explicit newline
            outputElement.scrollTop = outputElement.scrollHeight; // Auto-scroll to bottom
        }

        // Load Lua Environment
        fengari.load(`
            local js = require("js")
            local window = js.global
            local document = window.document

            -- HTML Elements
            local outputElement = document:getElementById("consoleOutput")

            -- Override print function
            function customPrint(...)
                local args = {}
                for i = 1, select("#", ...) do
                    table.insert(args, tostring(select(i, ...)))
                end
                js.global:customPrint(table.concat(args, " "))
            end
            _G.print = customPrint  -- Redirect Lua print() to JS console

            -- Handle Input
            function processInput(input)
                if input ~= "" then
                    print("Player input: " .. input)  -- Will now appear in HTML console
                    if _G.handlePlayerInput then
                        _G.handlePlayerInput(input)
                    else
                        print("No input handler defined.")
                    end
                end
            end

            -- Expose function to JS
            js.global.processLuaInput = processInput
        `)();

        // Function to load and run an external Lua file
        function loadLuaScript(url) {
            fetch(url)
            .then(response => response.text())
            .then(luaCode => {
                console.log("Loaded Lua Code:\n", luaCode); // Debugging

                // Run Lua script inside Fengari
                const luaEnv = fengari.load(luaCode);
                luaEnv();  // Execute script

                // Check if processPlayerInput is registered
                const luaGlobal = fengari.interop.getglobal("processPlayerInput");
                if (!luaGlobal) {
                    console.error("processPlayerInput is not defined in Lua!");
                } else {
                    console.log("Lua script loaded successfully!");
                }
            })
            .catch(error => console.error("Error loading Lua script:", error));
        }


        // Run the Lua file when the page loads
        loadLuaScript("https://raw.githubusercontent.com/ThatOneGuy2664/RPG-Text-Game/master/GameLoop.lua");

        function processLuaInput(input) {
            try {
                const luaFunc = fengari.interop.getglobal("processPlayerInput");
                if (luaFunc) {
                    fengari.load(`processPlayerInput("${input}")`)();  // Run function inside Lua
                } else {
                    console.error("Error: processPlayerInput is not available in Lua.");
                }
            } catch (err) {
                console.error("Error executing Lua function:", err);
            }
        }


        // Run when button is clicked
        runButton.addEventListener("click", () => {
            const input = inputElement.value.trim();
            inputElement.value = "";  // Clear input box
            if (input) {
                _G.processPlayerInput(input);  // Call Lua function from JS
            }
        });

        // Run when Enter is pressed
        inputElement.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                runButton.click();
            }
        });

    </script>

</body>
</html>
